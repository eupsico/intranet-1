<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avalia√ß√£o P√∫blica - EuPsico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      display: flex; 
      align-items: center;
      padding: 20px;
    }
    .container-center { 
      background: white; 
      border-radius: 8px; 
      padding: 40px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: auto;
    }
    h1 { 
      color: #667eea; 
      margin-bottom: 30px;
      text-align: center;
    }
    .pergunta-item {
      margin-bottom: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .btn-enviar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 12px 30px;
    }
    .btn-enviar:hover {
      background: linear-gradient(135deg, #5568d3 0%, #6a3c8f 100%);
    }
  </style>
</head>
<body>
  <div class="container-center">
    <h1><i class="fas fa-bullseye me-2"></i> Avalia√ß√£o - EuPsico</h1>
    
    <!-- CARREGAMENTO -->
    <div id="carregamento" class="text-center">
      <i class="fas fa-spinner fa-spin fa-3x mb-3" style="color: #667eea;"></i>
      <p>Carregando teste...</p>
    </div>

    <!-- CONTE√öDO DO TESTE -->
    <div id="conteudo-teste" style="display: none;">
      <div class="alert alert-info">
        <h4 id="titulo-teste"></h4>
        <p id="texto-teste"></p>
      </div>

      <form id="form-resposta">
        <!-- As perguntas ser√£o inseridas aqui -->
        <div id="perguntas-container"></div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-lg btn-enviar text-white">
            <i class="fas fa-check me-2"></i> Enviar Respostas
          </button>
        </div>
      </form>
    </div>

    <!-- ERRO -->
    <div id="erro-teste" class="alert alert-danger" style="display: none;"></div>

    <!-- SUCESSO -->
    <div id="sucesso-teste" class="alert alert-success" style="display: none;"></div>
  </div>

  <!-- ‚úÖ FIREBASE COMPAT (vers√£o est√°vel para HTML puro) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ============================================
    // INICIALIZA√á√ÉO FIREBASE
    // ============================================
    
    const firebaseConfig = {
      apiKey: "AIzaSyBXy_4yVPqyiuVJLv3kT-wXGaajgC3UJ10",
      authDomain: "eupsico-desenvolvimento.firebaseapp.com",
      projectId: "eupsico-desenvolvimento",
      storageBucket: "eupsico-desenvolvimento.appspot.com",
      messagingSenderId: "1065838851206",
      appId: "1:1065838851206:web:32b7a40d7f066d0d7c4c86"
    };

    // ‚úÖ Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ============================================
    // L√ìGICA PRINCIPAL
    // ============================================

    const params = new URLSearchParams(window.location.search);
    const testeId = params.get('id');
    const tipo = params.get('tipo');

    console.log('üîπ Teste ID:', testeId);
    console.log('üîπ Tipo:', tipo);

    async function carregarTeste() {
      try {
        if (!testeId) {
          mostrarErro('‚ùå Erro: ID do teste n√£o foi fornecido na URL.');
          return;
        }

        console.log('üîπ Buscando teste no Firebase...');

        // ‚úÖ Busca o teste no Firebase
        const testeSnap = await db
          .collection('estudos_de_caso')
          .doc(testeId)
          .get();

        if (!testeSnap.exists) {
          mostrarErro(`‚ùå Teste n√£o encontrado. ID: ${testeId}`);
          return;
        }

        const teste = testeSnap.data();
        console.log('‚úÖ Teste carregado:', teste);

        // Preenche as informa√ß√µes
        document.getElementById('titulo-teste').innerHTML = `
          <strong>${teste.titulo}</strong><br>
          <small>${teste.tipo.replace(/-/g, ' ')}</small>
        `;
        document.getElementById('texto-teste').textContent = teste.conteudo_texto;

        // Renderiza as perguntas
        const perguntasContainer = document.getElementById('perguntas-container');
        perguntasContainer.innerHTML = '';

        if (teste.perguntas && teste.perguntas.length > 0) {
          teste.perguntas.forEach((pergunta, index) => {
            const perguntaHtml = `
              <div class="pergunta-item">
                <label class="form-label">
                  <strong>Pergunta ${index + 1}:</strong> ${pergunta}
                </label>
                <textarea 
                  class="form-control" 
                  name="resposta-${index}"
                  placeholder="Digite sua resposta aqui..."
                  required
                ></textarea>
              </div>
            `;
            perguntasContainer.innerHTML += perguntaHtml;
          });
        } else {
          perguntasContainer.innerHTML = '<p class="alert alert-warning">Este teste n√£o possui perguntas.</p>';
        }

        // Mostra o conte√∫do
        document.getElementById('carregamento').style.display = 'none';
        document.getElementById('conteudo-teste').style.display = 'block';

        console.log('‚úÖ Teste renderizado com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao carregar teste:', error);
        mostrarErro(`‚ùå Erro ao carregar o teste: ${error.message}`);
      }
    }

    function mostrarErro(mensagem) {
      document.getElementById('carregamento').style.display = 'none';
      document.getElementById('erro-teste').innerHTML = mensagem;
      document.getElementById('erro-teste').style.display = 'block';
    }

    // ‚úÖ Listener do formul√°rio
    document.getElementById('form-resposta')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      console.log('üîπ Enviando respostas...');
      
      const formData = new FormData(e.target);
      const respostas = {};
      
      for (let [key, value] of formData.entries()) {
        respostas[key] = value;
      }

      console.log('‚úÖ Respostas:', respostas);
      
      // Aqui voc√™ pode salvar no Firebase se desejar
      document.getElementById('conteudo-teste').style.display = 'none';
      document.getElementById('sucesso-teste').innerHTML = `
        <h4>‚úÖ Respostas Enviadas com Sucesso!</h4>
        <p>Obrigado por participar da avalia√ß√£o. Entraremos em contato em breve com o resultado.</p>
      `;
      document.getElementById('sucesso-teste').style.display = 'block';
    });

    // Carrega o teste ao abrir a p√°gina
    carregarTeste();
  </script>
</body>
</html>
