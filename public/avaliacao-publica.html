<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avalia√ß√£o P√∫blica - EuPsico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      display: flex; 
      align-items: center;
      padding: 20px;
    }
    .container-center { 
      background: white; 
      border-radius: 8px; 
      padding: 40px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: auto;
    }
    h1 { 
      color: #667eea; 
      margin-bottom: 30px;
      text-align: center;
    }
    .pergunta-item {
      margin-bottom: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .btn-enviar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 12px 30px;
    }
    .btn-enviar:hover {
      background: linear-gradient(135deg, #5568d3 0%, #6a3c8f 100%);
    }
    .info-candidato {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #0078d4;
    }
    .tipo-pergunta-badge {
      display: inline-block;
      background: #e8f4f8;
      color: #0078d4;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85rem;
      margin-left: 10px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container-center">
    <h1><i class="fas fa-bullseye me-2"></i> Avalia√ß√£o - EuPsico</h1>
    
    <!-- CARREGAMENTO -->
    <div id="carregamento" class="text-center">
      <i class="fas fa-spinner fa-spin fa-3x mb-3" style="color: #667eea;"></i>
      <p>Validando acesso e carregando teste...</p>
    </div>

    <!-- CONTE√öDO DO TESTE -->
    <div id="conteudo-teste" style="display: none;">
      <!-- ‚úÖ NOVO: Informa√ß√µes do candidato -->
      <div class="info-candidato">
        <p class="mb-1">
          <strong>üìã Candidato(a):</strong> <span id="info-candidato-nome">-</span>
        </p>
        <p class="mb-0">
          <strong>‚è±Ô∏è Prazo:</strong> <span id="info-candidato-prazo">-</span>
        </p>
      </div>

      <div class="alert alert-info">
        <h4 id="titulo-teste"></h4>
        <p id="texto-teste"></p>
      </div>

      <form id="form-resposta">
        <!-- As perguntas ser√£o inseridas aqui -->
        <div id="perguntas-container"></div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-lg btn-enviar text-white">
            <i class="fas fa-check me-2"></i> Enviar Respostas
          </button>
        </div>
      </form>
    </div>

    <!-- ERRO -->
    <div id="erro-teste" class="alert alert-danger" style="display: none;"></div>

    <!-- SUCESSO -->
    <div id="sucesso-teste" class="alert alert-success" style="display: none;"></div>
  </div>

  <!-- ‚úÖ FIREBASE COMPAT (vers√£o est√°vel para HTML puro) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ============================================
    // INICIALIZA√á√ÉO FIREBASE
    // ============================================
    
    const firebaseConfig = {
      apiKey: "AIzaSyBXy_4yVPqyiuVJLv3kT-wXGaajgC3UJ10",
      authDomain: "eupsico-desenvolvimento.firebaseapp.com",
      projectId: "eupsico-desenvolvimento",
      storageBucket: "eupsico-desenvolvimento.appspot.com",
      messagingSenderId: "1065838851206",
      appId: "1:1065838851206:web:32b7a40d7f066d0d7c4c86"
    };

    // ‚úÖ Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ============================================
    // L√ìGICA PRINCIPAL (COM TOKEN)
    // ============================================

    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const testeIdAntigo = params.get('id'); // Para backward compatibility

    let tokenData = null;
    let testeId = null;

    console.log('üîπ Token recebido:', token);
    console.log('üîπ ID (backup):', testeIdAntigo);

    async function carregarTeste() {
      try {
        // ‚úÖ 1Ô∏è‚É£ VALIDA O TOKEN
        if (token) {
          console.log('üîπ Validando token...');
          
          const tokenSnap = await db
            .collection('tokens_acesso')
            .doc(token)
            .get();

          if (!tokenSnap.exists) {
            mostrarErro('‚ùå Token inv√°lido ou n√£o encontrado.');
            console.error('Token n√£o existe no banco');
            return;
          }

          tokenData = tokenSnap.data();
          console.log('üîπ Dados do token:', tokenData);

          // ‚úÖ 2Ô∏è‚É£ VERIFICA SE EXPIROU
          const agora = new Date();
          const expiraEm = tokenData.expiraEm.toDate ? tokenData.expiraEm.toDate() : new Date(tokenData.expiraEm);

          if (agora > expiraEm) {
            mostrarErro('‚ùå Link expirado! O prazo de resposta j√° encerrou. Por favor, solicite um novo link ao RH.');
            console.error('Token expirado');
            return;
          }

          console.log('‚úÖ Token v√°lido e n√£o expirado');

          // ‚úÖ 3Ô∏è‚É£ VERIFICA SE J√Å FOI USADO
          if (tokenData.usado) {
            mostrarErro('‚ö†Ô∏è Este link j√° foi utilizado! Voc√™ j√° respondeu a este teste.');
            console.warn('Token j√° foi usado');
            return;
          }

          // ‚úÖ 4Ô∏è‚É£ PEGA O ID DO TESTE DO TOKEN
          testeId = tokenData.testeId;
          console.log('üîπ Carregando teste:', testeId);
        } else if (testeIdAntigo) {
          // FALLBACK: Se n√£o houver token, tenta com ID (modo backward compatibility)
          console.log('‚ö†Ô∏è Usando ID ao inv√©s de TOKEN (modo compatibilidade)');
          testeId = testeIdAntigo;
        } else {
          mostrarErro('‚ùå Erro: Nenhum token ou ID foi fornecido na URL.');
          return;
        }

        // ‚úÖ 5Ô∏è‚É£ CARREGA O TESTE
        const testeSnap = await db
          .collection('estudos_de_caso')
          .doc(testeId)
          .get();

        if (!testeSnap.exists) {
          mostrarErro(`‚ùå Teste n√£o encontrado.`);
          return;
        }

        const teste = testeSnap.data();
        console.log('‚úÖ Teste carregado:', teste);

        // ‚úÖ 6Ô∏è‚É£ RENDERIZA O TESTE
        renderizarTeste(teste);

        // ‚úÖ 7Ô∏è‚É£ MARCA O TOKEN COMO "EM USO" (se estiver usando token)
        if (token && tokenData) {
          await db
            .collection('tokens_acesso')
            .doc(token)
            .update({
              usado: true,
              dataUso: new Date(),
              dataInicioResposta: new Date()
            });

          console.log('‚úÖ Token marcado como usado');
        }

      } catch (error) {
        console.error('‚ùå Erro ao carregar teste:', error);
        mostrarErro(`‚ùå Erro ao carregar o teste: ${error.message}`);
      }
    }

    function renderizarTeste(teste) {
      // Preenche as informa√ß√µes
      document.getElementById('titulo-teste').innerHTML = `
        <strong>${teste.titulo}</strong><br>
        <small>${teste.tipo.replace(/-/g, ' ')}</small>
      `;
      document.getElementById('texto-teste').textContent = teste.conteudo_texto;

      // ‚úÖ NOVO: Exibe informa√ß√µes do candidato
      if (tokenData) {
        document.getElementById('info-candidato-nome').textContent = tokenData.nomeCandidato || 'Candidato(a)';
        const prazoDias = tokenData.prazoDias || 7;
        const expiraEm = tokenData.expiraEm.toDate ? tokenData.expiraEm.toDate() : new Date(tokenData.expiraEm);
        const dataFormatada = expiraEm.toLocaleDateString('pt-BR');
        document.getElementById('info-candidato-prazo').textContent = `${prazoDias} dias (vence em ${dataFormatada})`;
      }

      // Renderiza as perguntas
      const perguntasContainer = document.getElementById('perguntas-container');
      perguntasContainer.innerHTML = '';

      if (teste.perguntas && teste.perguntas.length > 0) {
        teste.perguntas.forEach((pergunta, index) => {
          let perguntaHtml = '';

          // ‚úÖ RENDERIZA DIFERENTES TIPOS DE PERGUNTAS
          if (pergunta.tipo === 'multipla-escolha') {
            perguntaHtml = `
              <div class="pergunta-item">
                <label class="form-label">
                  <strong>Pergunta ${index + 1}:</strong> ${pergunta.enunciado}
                  <span class="tipo-pergunta-badge">M√∫ltipla Escolha</span>
                </label>
                <div class="mt-3">
            `;

            pergunta.opcoes.forEach((opcao, opcaoIdx) => {
              perguntaHtml += `
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="resposta-${index}" id="opcao-${index}-${opcaoIdx}" value="${opcao.texto}" required>
                  <label class="form-check-label" for="opcao-${index}-${opcaoIdx}">
                    ${opcao.texto}
                  </label>
                </div>
              `;
            });

            perguntaHtml += `</div></div>`;
          } else if (pergunta.tipo === 'verdadeiro-falso') {
            perguntaHtml = `
              <div class="pergunta-item">
                <label class="form-label">
                  <strong>Pergunta ${index + 1}:</strong> ${pergunta.enunciado}
                  <span class="tipo-pergunta-badge">Verdadeiro/Falso</span>
                </label>
                <div class="mt-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="resposta-${index}" id="verdadeiro-${index}" value="Verdadeiro" required>
                    <label class="form-check-label" for="verdadeiro-${index}">
                      ‚úÖ Verdadeiro
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="resposta-${index}" id="falso-${index}" value="Falso" required>
                    <label class="form-check-label" for="falso-${index}">
                      ‚ùå Falso
                    </label>
                  </div>
                </div>
              </div>
            `;
          } else {
            // Dissertativa (padr√£o)
            perguntaHtml = `
              <div class="pergunta-item">
                <label class="form-label">
                  <strong>Pergunta ${index + 1}:</strong> ${pergunta.enunciado}
                  <span class="tipo-pergunta-badge">Dissertativa</span>
                </label>
                <textarea 
                  class="form-control mt-2" 
                  name="resposta-${index}"
                  placeholder="Digite sua resposta aqui..."
                  required
                ></textarea>
              </div>
            `;
          }

          perguntasContainer.innerHTML += perguntaHtml;
        });
      } else {
        perguntasContainer.innerHTML = '<p class="alert alert-warning">Este teste n√£o possui perguntas.</p>';
      }

      // Mostra o conte√∫do
      document.getElementById('carregamento').style.display = 'none';
      document.getElementById('conteudo-teste').style.display = 'block';

      console.log('‚úÖ Teste renderizado com sucesso');
    }

    function mostrarErro(mensagem) {
      document.getElementById('carregamento').style.display = 'none';
      document.getElementById('erro-teste').innerHTML = mensagem;
      document.getElementById('erro-teste').style.display = 'block';
    }

    // ‚úÖ Listener do formul√°rio
    document.getElementById('form-resposta')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      console.log('üîπ Enviando respostas...');
      
      const formData = new FormData(e.target);
      const respostas = {};
      
      for (let [key, value] of formData.entries()) {
        respostas[key] = value;
      }

      console.log('‚úÖ Respostas:', respostas);
      
      // ‚úÖ SALVA AS RESPOSTAS NO TOKEN
      try {
        if (token && tokenData) {
          await db
            .collection('tokens_acesso')
            .doc(token)
            .update({
              respostas: respostas,
              respondidoEm: new Date(),
              tempoRespostaSegundos: Math.floor((new Date() - new Date(tokenData.dataInicioResposta)) / 1000)
            });

          console.log('‚úÖ Respostas salvas no Firestore');
        }
      } catch (error) {
        console.error('‚ùå Erro ao salvar respostas:', error);
      }

      document.getElementById('conteudo-teste').style.display = 'none';
      document.getElementById('sucesso-teste').innerHTML = `
        <h4>‚úÖ Respostas Enviadas com Sucesso!</h4>
        <p>Obrigado por participar da avalia√ß√£o. Entraremos em contato em breve com o resultado.</p>
      `;
      document.getElementById('sucesso-teste').style.display = 'block';
    });

    // Carrega o teste ao abrir a p√°gina
    carregarTeste();
  </script>
</body>
</html>
