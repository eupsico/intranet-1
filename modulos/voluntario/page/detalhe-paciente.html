<div class="container-fluid" id="detalhe-paciente-view">

    <div class="detalhe-paciente-header">
        <h2 id="paciente-nome-header">Carregando...</h2>
        <a href="#meus-pacientes" class="action-button secondary-button">&larr; Voltar para Meus Pacientes</a>
    </div>

<div class="action-buttons-container main-actions">
        <button id="btn-abrir-modal-mensagem" class="action-button">Enviar Mensagem</button>
        <button id="btn-abrir-modal-solicitar-sessoes" class="action-button">Solicitar Novas Sessões</button>
        <button id="btn-abrir-modal-alterar-horario" class="action-button">Alterar Horário</button>

        <div class="dropdown-container">
            <button id="btn-mais-acoes" class="action-button secondary-button dropdown-toggle">
                Mais Ações <span class="dropdown-arrow">&#9662;</span> </button>
            <div class="dropdown-menu" id="dropdown-menu-acoes">
                <button id="btn-abrir-modal-reavaliacao" class="dropdown-item action-button secondary-button">Solicitar Reavaliação</button>
                <button id="btn-abrir-modal-desfecho-pb" class="dropdown-item action-button danger-button">Registrar Desfecho PB</button>
                <button id="btn-abrir-modal-encerramento-plantao" class="dropdown-item action-button danger-button">Registrar Encerramento Plantão</button>
                <button id="btn-abrir-modal-horarios-pb" class="dropdown-item action-button special-button" title="Usar quando o paciente está aguardando informação de horários">Informar Horários PB</button>
            </div>
        </div>
    </div>

        <div class="detalhe-paciente-forms-column">

            <div class="accordion-container"> <form id="form-info-pessoais">
                <fieldset class="accordion-item open"> 
                    <legend class="accordion-header">
                        <button type="button" class="accordion-button">
                            INFORMAÇÕES PESSOAIS
                            <span class="accordion-icon">&#9660;</span> </button>
                    </legend>
                    <div class="accordion-content"> 

                        <div class="info-summary-grid">
                            <div class="form-group readonly">
                                <label for="dp-status-atual-input">Status Atual:</label>
                                <input type="text" id="dp-status-atual-input" class="form-control status-badge-input" readonly> 
                                <span id="dp-status-atual" class="readonly-value status-badge" style="display: none;">--</span> 
                            </div>
                            <div class="form-group readonly">
                                <label for="dp-idade-input">Idade:</label>
                                <input type="text" id="dp-idade-input" class="form-control" readonly>
                                <span id="dp-idade" class="readonly-value" style="display: none;">--</span>
                            </div>
                            <div class="form-group readonly">
                                <label for="dp-desde-input">Desde (Encaminhamento):</label>
                                <input type="text" id="dp-desde-input" class="form-control" readonly>
                                <span id="dp-desde" class="readonly-value" style="display: none;">--</span>
                            </div>
                        </div>
                        <div class="form-grid cols-1">
                            <div class="form-group">
                                <label for="dp-nome-completo">Nome completo</label>
                                <input type="text" id="dp-nome-completo" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="dp-telefone">Telefone</label>
                                <input type="text" id="dp-telefone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="dp-data-nascimento">Data de Nascimento</label>
                                <input type="date" id="dp-data-nascimento" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="dp-cpf">CPF</label>
                                <input type="text" id="dp-cpf" class="form-control" readonly>
                            </div>
                        </div>

                        <div class="sub-legend">Endereço</div>
                         <div class="form-grid cols-2">
                             <div class="form-group grid-col-span-2">
                                 <label for="dp-endereco-logradouro">Logradouro:</label>
                                <input type="text" id="dp-endereco-logradouro" class="form-control" placeholder="Rua, Av...">
                             </div>
                             <div class="form-group">
                                <label for="dp-endereco-numero">Número:</label>
                                <input type="text" id="dp-endereco-numero" class="form-control" >
                             </div>
                             <div class="form-group">
                                <label for="dp-endereco-complemento">Complemento:</label>
                                <input type="text" id="dp-endereco-complemento" class="form-control">
                             </div>
                             <div class="form-group">
                                <label for="dp-endereco-bairro">Bairro:</label>
                                <input type="text" id="dp-endereco-bairro" class="form-control">
                             </div>
                             <div class="form-group">
                                <label for="dp-endereco-cidade">Cidade:</label>
                                <input type="text" id="dp-endereco-cidade" class="form-control">
                             </div>
                             <div class="form-group">
                                <label for="dp-endereco-estado">Estado:</label>
                                <input type="text" id="dp-endereco-estado" class="form-control" maxlength="2">
                             </div>
                             <div class="form-group">
                                <label for="dp-endereco-cep">CEP:</label>
                                <input type="text" id="dp-endereco-cep" class="form-control" placeholder="00000-000">
                             </div>
                        </div>
                        
                        <div class="sub-legend">Contatos</div>
                          <div class="form-grid cols-1">
                              <div class="form-group">
                                <label for="dp-responsavel-nome">Nome do Responsável (se aplicável)</label>
                                <input type="text" id="dp-responsavel-nome" class="form-control">
                             </div>
                             <div class="form-group">
                                <label for="dp-contato-emergencia-nome">Contato de Emergência (Nome)</label>
                                <input type="text" id="dp-contato-emergencia-nome" class="form-control">
                             </div>
                             <div class="form-group">
                                <label for="dp-contato-emergencia-telefone">Contato de Emergência (Telefone)</label>
                                <input type="text" id="dp-contato-emergencia-telefone" class="form-control">
                             </div>
                        </div>

                        <div class="button-bar" style="margin-top: 20px;">
                            <button type="submit" class="action-button" id="btn-salvar-info-pessoais">Salvar Alterações Pessoais</button>
                        </div>

                    </div> </fieldset>
            </form>

            <form id="form-info-financeiras">
                <fieldset class="accordion-item"> 
                    <legend class="accordion-header">
                        <button type="button" class="accordion-button">
                            INFORMAÇÕES FINANCEIRAS
                            <span class="accordion-icon">&#9654;</span> </button>
                    </legend>
                    <div class="accordion-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="dp-valor-contribuicao">Valor da Contribuição Mensal (R$)</label>
                                <input type="text" id="dp-valor-contribuicao" class="form-control" placeholder="Ex: 50,00">
                            </div>
                            <div class="button-bar" style="margin-top: 20px;">
                                <button type="submit" class="action-button" id="btn-salvar-info-financeiras">Salvar Contribuição</button>
                            </div>
                        </div>
                    </div> </fieldset>
            </form>
            </div> <div id="pendencias-section">
                <fieldset>
                    <legend>PENDÊNCIAS <span id="pendencias-count-badge" class="badge" style="display: none;">0</span></legend>
                     <div id="pendencias-loading" style="display: none;"><div class="loading-spinner"></div> Verificando pendências...</div>
                     <ul id="pendencias-list" class="pendencias-list-items">
                         </ul>
                     <div id="pendencias-placeholder" style="display: none; text-align: center; padding: 15px;">Nenhuma pendência encontrada.</div>
                </fieldset>
             </div>
        </div>
             <div id="pendencias-section">
                <fieldset>
                    <legend>PENDÊNCIAS <span id="pendencias-count-badge" class="badge" style="display: none;">0</span></legend>
                     <div id="pendencias-loading" style="display: none;"><div class="loading-spinner"></div> Verificando pendências...</div>
                     <ul id="pendencias-list" class="pendencias-list-items">
                         </ul>
                     <div id="pendencias-placeholder" style="display: none; text-align: center; padding: 15px;">Nenhuma pendência encontrada.</div>
                </fieldset>
             </div>
             </div> <div class="detalhe-paciente-tabs-column">
            <div class="tabs-container vertical-tabs"> <button class="tab-link active" data-tab="tab-sessoes">Sessões</button>
                <button class="tab-link" data-tab="tab-acompanhamento">Acompanhamento Clínico</button>
                <button class="tab-link" data-tab="tab-prontuario">Prontuário Psicológico</button>
                 </div>

            <div class="tabs-content-container">
                <div id="tab-sessoes" class="tab-content active">
                    <div class="session-list" id="session-list-container">
                        <div class="session-list-placeholder" id="session-list-placeholder" style="display: none;">
                            <p>Nenhuma sessão encontrada para este paciente.</p>
                        </div>
                        <div class="loading-spinner" id="session-list-loading"></div>
                    </div>
                </div>

                <div id="tab-acompanhamento" class="tab-content">
                    <form id="acompanhamento-clinico-form">
                        <fieldset>
                            <legend>Acompanhamento Clínico</legend>

                            <div class="form-group">
                                <label for="ac-avaliacao-demanda">AVALIAÇÃO DA DEMANDA (QUEIXA DO PACIENTE)</label>
                                <p class="field-description">(Explicação: Descreva a queixa principal trazida pelo paciente no início do tratamento.)</p>
                                <textarea id="ac-avaliacao-demanda" rows="6" class="form-control"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="ac-definicao-objetivos">DEFINIÇÃO DE OBJETIVOS DO TRATAMENTO (PLANOS DE TRATAMENTO)</label>
                                <p class="field-description">(Explicação: Liste os objetivos acordados com o paciente para o processo terapêutico.)</p>
                                <textarea id="ac-definicao-objetivos" rows="6" class="form-control"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="ac-diagnostico">DIAGNÓSTICO</label>
                                <p class="field-description">(Explicação: Informe o diagnóstico (se houver), conforme CID ou DSM.)</p>
                                <textarea id="ac-diagnostico" rows="6" class="form-control"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="ac-registro-encerramento">REGISTRO DE ENCERRAMENTO</label>
                                <p class="field-description">(Explicação: Deve ser utilizado em caso de alta, desistência ou encaminhamento, descrevendo o motivo e o desfecho do processo.)</p>
                                <textarea id="ac-registro-encerramento" rows="6" class="form-control"></textarea>
                            </div>

                            <div class="button-bar">
                                <button type="submit" class="action-button" id="btn-salvar-acompanhamento">Salvar Acompanhamento Clínico</button>
                            </div>
                        </fieldset>
                    </form>
                </div>

                <div id="tab-prontuario" class="tab-content">
                    <div class="prontuario-generator-layout">
                        <form id="form-gerar-prontuario">
                            <fieldset>
                                <legend>Gerar Prontuário em PDF</legend>
                                <p>Selecione as informações que devem constar no prontuário:</p>
                                <div class="checkbox-grid">
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="info_pessoais" checked> Informações Pessoais</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="info_financeiras" checked> Informações Financeiras</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="ac_demanda" checked> Avaliação da Demanda</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="ac_objetivos" checked> Objetivos do Tratamento</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="ac_diagnostico" checked> Diagnóstico</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="ac_encerramento" checked> Registro de Encerramento</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="sessoes_lista" checked> Lista de Sessões (Datas e Status)</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="sessoes_evolucao" checked> Ficha Evolução (de todas as sessões)</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="sessoes_compartilhado_prof" checked> Campo Compartilhado (Profissionais)</label>
                                    <label class="form-check"><input type="checkbox" class="form-check-input" name="prontuario-item" value="sessoes_compartilhado_admin" checked> Campo Compartilhado (Admin)</label>
                                </div>
                            </fieldset>
                        </form>
                        <div class="prontuario-generator-actions">
                            <p>O documento será gerado em formato PDF e incluirá os dados do profissional e do paciente.</p>
                            <button type="button" class="action-button" id="btn-gerar-prontuario-pdf">Gerar PDF</button>
                        </div>
                    </div>
                </div>
            </div> </div> </div> </div>

<div id="anotacoes-sessao-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large flex-layout"> 
        <form id="anotacoes-sessao-form">
            <div class="modal-header">
                <h2 class="modal-title-text">Anotações da Sessão</h2>
                <span class="close-button modal-cancel-btn">&times;</span>
            </div>
            
            <div class="modal-body"> 
                <input type="hidden" id="anotacoes-sessao-id">

                <div class="tabs-container horizontal-tabs" id="anotacoes-tabs-nav">
                    <button type="button" class="tab-link active" data-tab="anotacao-tab-evolucao">Ficha Evolução</button>
                    <button type="button" class="tab-link" data-tab="anotacao-tab-prof">Comp. Profissionais</button>
                    <button type="button" class="tab-link" data-tab="anotacao-tab-admin">Comp. Admin</button>
                </div>

                <div class="tabs-content-container" id="anotacoes-tabs-content">
                    
                    <div id="anotacao-tab-evolucao" class="tab-content active">
                        <div class="form-group">
                            <label for="anotacoes-ficha-evolucao">Ficha Evolução</label>
                            <p class="field-description">
                                Este é o campo referente ao item do prontuário chamado Registro de evolução do quadro. Faz parte das diretrizes exigidas pelo CFP na Resolução 001/2009. É importante que os pontos principais da análise sejam inseridos de forma sucinta e resumida, mantendo a evolução registrada.
                            </p>
                            <textarea id="anotacoes-ficha-evolucao" rows="8" class="form-control"></textarea>
                        </div>
                    </div>

                    <div id="anotacao-tab-prof" class="tab-content">
                        <div class="form-group">
                            <label for="anotacoes-campo-compartilhado-prof">Campo Compartilhado (entre profissionais)</label>
                            <p class="field-description">
                                <strong>Atenção:</strong> Essas anotações são acessíveis e editáveis por todos os profissionais envolvidos no atendimento ao cliente, bem como pelo administrador. É importante observar que <strong>informações confidenciais não devem ser incluídas</strong> neste campo.
                            </p>
                            <textarea id="anotacoes-campo-compartilhado-prof" rows="5" class="form-control"></textarea>
                        </div>
                    </div>

                    <div id="anotacao-tab-admin" class="tab-content">
                        <div class="form-group">
                            <label for="anotacoes-campo-compartilhado-admin">Campo Compartilhado (com administrador)</label>
                            <p class="field-description">
                                Todas as anotações feitas nesse campo são compartilhadas com o administrador da sua clínica para serem visualizadas e estão de acordo com as diretrizes exigidas pelo CFP na Resolução 001/2009.
                            </p>
                            <textarea id="anotacoes-campo-compartilhado-admin" rows="5" class="form-control"></textarea>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
                <button type="submit" class="action-button" id="btn-salvar-anotacoes">Salvar Anotações</button>
            </div>
        </form>
    </div>
</div>
<div id="solicitar-sessoes-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header"> <h2 class="modal-title-text">Solicitar Novas Sessões</h2>
            <span class="close-button modal-cancel-btn">&times;</span>
        </div>
        <div class="modal-body">
            <form id="solicitar-sessoes-form">
                <input type="hidden" id="solicitar-paciente-id">
                <input type="hidden" id="solicitar-atendimento-id">

                <fieldset>
                    <legend>Dados do Agendamento</legend>
                    <div class="form-grid cols-2"> <div class="form-group">
                            <label>Nome do Profissional</label>
                            <input type="text" id="solicitar-profissional-nome" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Nome do Paciente</label>
                            <input type="text" id="solicitar-paciente-nome" class="form-control" readonly>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Detalhes da Nova Sessão</legend>
                    <div class="form-grid cols-3"> <div class="form-group">
                            <label for="solicitar-dia-semana">Dia da Sessão</label>
                            <select id="solicitar-dia-semana" class="form-control" required>
                                <option value="">Selecione...</option> <option value="Segunda-feira">Segunda-feira</option>
                                <option value="Terça-feira">Terça-feira</option>
                                <option value="Quarta-feira">Quarta-feira</option>
                                <option value="Quinta-feira">Quinta-feira</option>
                                <option value="Sexta-feira">Sexta-feira</option>
                                <option value="Sábado">Sábado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="solicitar-horario">Horário</label>
                            <select id="solicitar-horario" class="form-control" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="solicitar-tipo-atendimento">Tipo de Atendimento</label>
                            <select id="solicitar-tipo-atendimento" class="form-control" required>
                                <option value="">Selecione...</option> <option value="online">Online</option>
                                <option value="presencial">Presencial</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid cols-2"> <div class="form-group">
                            <label for="solicitar-data-inicio">Iniciar sessões a partir de:</label>
                            <input type="date" id="solicitar-data-inicio" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="solicitar-sala">Sala de Atendimento</label>
                            <select id="solicitar-sala" class="form-control" required>
                                <option value="Online">Online</option>
                                 </select>
                        </div>
                    </div>
                </fieldset>
                <div id="validacao-grade-feedback" class="info-note" style="display: none;"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
            <button type="button" class="action-button" id="btn-confirmar-solicitacao">Enviar Solicitação</button>
        </div>
    </div>
</div>

<div id="encerramento-modal" class="modal-overlay" style="display: none;"> <div class="modal-content">
        <div class="modal-header">
            <h3 id="encerramento-modal-title">Encerrar Plantão</h3>
            <span class="close-button modal-cancel-btn">&times;</span>
        </div>
        <div class="modal-body">
            <form id="encerramento-form">
                <input type="hidden" id="paciente-id-modal">
                <div class="form-group">
                    <label>Encaminhamento:</label>
                    <div id="encerramento-encaminhamento" class="checkbox-grid"> <label><input type="checkbox" name="encaminhamento" value="Alta"> Alta</label>
                        <label><input type="checkbox" name="encaminhamento" value="Desistência"> Desistência</label>
                        <label><input type="checkbox" name="encaminhamento" value="Atendimento Psicológico"> Atendimento Psicológico</label>
                        <label><input type="checkbox" name="encaminhamento" value="Atendimento Psicopedagógico"> Atendimento Psicopedagógico</label>
                        <label><input type="checkbox" name="encaminhamento" value="Atendimento com musicoterapeuta"> Atendimento com musicoterapeuta</label>
                        <label><input type="checkbox" name="encaminhamento" value="RAPS"> RAPS</label>
                        <label><input type="checkbox" name="encaminhamento" value="Grupo Questões de peso"> Grupo Questões de peso</label>
                        <label class="disabled"><input type="checkbox" name="encaminhamento" value="Grupo papo de adolescente" disabled> Grupo papo de adolescente (Inativo)</label>
                        <label class="disabled"><input type="checkbox" name="encaminhamento" value="Grupo de apoio à família" disabled> Grupo de apoio à família (Inativo)</label>
                        <label><input type="checkbox" name="encaminhamento" value="Grupo Funcional"> Grupo Funcional</label>
                        <label><input type="checkbox" name="encaminhamento" value="Grupo Envelhecimento Ativo"> Grupo Envelhecimento Ativo</label>
                        <label class="disabled"><input type="checkbox" name="encaminhamento" value="Grupo TransVivências" disabled> Grupo TransVivências (Inativo)</label>
                        <label><input type="checkbox" name="encaminhamento" value="Grupo Reexista"> Grupo Reexista</label>
                    </div>
                </div>
                <div class="form-group"><label for="data-encerramento">Data de encerramento/alta/desistência:</label><input type="date" id="data-encerramento" required class="form-control"></div>
                <div class="form-group"><label for="quantidade-sessoes">Quantidade de sessões do plantão:</label><input type="number" id="quantidade-sessoes" required class="form-control"></div>
                <div class="form-group"><label for="pagamento-contribuicao">O paciente efetuou o pagamento da contribuição?</label><select id="pagamento-contribuicao" required class="form-control"><option value="">Selecione...</option><option value="sim">Sim</option><option value="nao">Não</option></select></div>
                <div id="motivo-nao-pagamento-container" class="form-group hidden"><label for="motivo-nao-pagamento">Motivo do não pagamento:</label><textarea id="motivo-nao-pagamento" rows="3" class="form-control"></textarea></div>
                <div class="form-group"><label for="relato-encerramento">Breve relato (alta, desistência ou encaminhamento):</label><textarea id="relato-encerramento" rows="4" placeholder="Utilize esse campo para informar o que houve com o processo de plantão desse paciente..." required class="form-control"></textarea></div>
                <div class="form-group"><label>A disponibilidade de atendimento continua a mesma?</label><p id="disponibilidade-atual" style="font-weight: bold; color: var(--cor-primaria);"></p><select id="manter-disponibilidade" required class="form-control"><option value="">Selecione...</option><option value="sim">Sim</option><option value="nao">Não</option></select></div>
                <div id="nova-disponibilidade-container" class="hidden"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
            <button type="submit" id="modal-save-btn" class="action-button" form="encerramento-form">Salvar</button>
        </div>
    </div>
</div>

<div id="horarios-pb-modal" class="modal-overlay" style="display: none;"> <div class="modal-content">
        <div class="modal-header">
            <h3>Informar Horários - Psicoterapia Breve (PB)</h3><span class="close-button modal-cancel-btn">&times;</span>
        </div>
        <div class="modal-body">
            <form id="horarios-pb-form"><input type="hidden" id="paciente-id-horarios-modal"><input type="hidden" id="atendimento-id-horarios-modal">
                <div class="form-group"><label>Paciente iniciou o atendimento em PB?</label>
                    <div><input type="radio" id="iniciou-pb-sim" name="iniciou-pb" value="sim" required> <label for="iniciou-pb-sim">Sim</label><input type="radio" id="iniciou-pb-nao" name="iniciou-pb" value="nao" required> <label for="iniciou-pb-nao">Não</label><small style="display: block; margin-left: 25px; color: #666;">Selecione 'Não' apenas se o paciente desistiu ou não irá mais ser atendido por você.</small></div>
                </div>
                <div id="motivo-nao-inicio-pb-container" class="form-group hidden"><label>Qual o motivo do não início do atendimento?</label>
                    <div class="radio-group-vertical"><label><input type="radio" name="motivo-nao-inicio" value="desistiu"> Desistiu</label><label><input type="radio" name="motivo-nao-inicio" value="outra_modalidade"> Prefere outra modalidade de atendimento ou outro horário</label></div>
                </div>
                <div id="motivo-desistencia-container" class="form-group hidden"><label for="motivo-desistencia-pb">Descreva o motivo da desistência:</label><textarea id="motivo-desistencia-pb" rows="3" class="form-control"></textarea></div>
                <div id="detalhar-solicitacao-container" class="form-group hidden"><label for="detalhes-solicitacao-pb">Detalhe a solicitação do paciente (será enviada ao administrativo):</label><textarea id="detalhes-solicitacao-pb" rows="3" class="form-control"></textarea></div>
                <div id="form-continuacao-pb" class="hidden"></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button><button type="submit" class="action-button" form="horarios-pb-form">Salvar</button></div>
    </div>
</div>

<div id="enviar-mensagem-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 class="modal-title-text">Enviar Mensagem</h2>
             <span class="close-button modal-cancel-btn">&times;</span> </div>
        <div class="modal-body">
            <div id="mensagem-selecao-view">
                <p>Escolha um modelo de mensagem para enviar para <strong><span id="mensagem-paciente-nome-selecao"></span></strong>:</p>
                <div id="lista-modelos-mensagem" class="message-templates-list"></div>
            </div>
            <div id="mensagem-formulario-view" style="display: none;">
                <button type="button" id="btn-voltar-selecao" class="action-button secondary-button" style="margin-bottom: 20px;">&larr; Voltar para Modelos</button>
                <form id="mensagem-dynamic-form">
                    <h3 id="mensagem-form-title" style="color: var(--cor-primaria); margin-top: 0;"></h3>
                    <div id="mensagem-dynamic-form-container" class="dynamic-form-fields"></div>
                    <div class="output-area" style="margin-top: 20px;">
                        <label>Pré-visualização da Mensagem:</label>
                        <textarea readonly id="output-mensagem-preview" rows="5"></textarea> </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
            <button type="button" id="btn-gerar-enviar-whatsapp" class="action-button">Gerar e Enviar para WhatsApp</button>
        </div>
    </div>
</div>

<div id="desfecho-pb-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h3>Registrar Desfecho do Atendimento (PB)</h3>
            <span class="close-button modal-cancel-btn">&times;</span> </div>
        <div id="desfecho-pb-modal-body" class="modal-body">
            </div>
        <div id="desfecho-pb-modal-footer" class="modal-footer" style="display: none;">
            <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
             <button type="submit" id="btn-salvar-desfecho-submit" class="action-button" form="form-atendimento-pb">Salvar Desfecho</button>
        </div>
    </div>
</div>

<div id="alterar-horario-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 class="modal-title-text">Solicitar Alteração de Horário/Modalidade</h2>
             <span class="close-button modal-cancel-btn">&times;</span> </div>
        <div class="modal-body">
            <form id="alterar-horario-form">
                <input type="hidden" id="alterar-paciente-id">
                <input type="hidden" id="alterar-atendimento-id">

                <fieldset>
                    <legend>Dados Atuais</legend>
                    <div class="form-grid cols-2"> <div class="form-group">
                            <label>Nome do Paciente</label>
                            <input type="text" id="alterar-paciente-nome" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Profissional</label>
                            <input type="text" id="alterar-profissional-nome" class="form-control" readonly>
                        </div>
                    </div>
                     <div class="form-grid cols-3"> <div class="form-group">
                            <label>Dia Atual</label>
                            <input type="text" id="alterar-dia-atual" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Horário Atual</label>
                            <input type="text" id="alterar-horario-atual" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Modalidade Atual</label>
                            <input type="text" id="alterar-modalidade-atual" class="form-control" readonly>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Nova Configuração da Sessão</legend>
                    <div class="form-grid cols-3"> <div class="form-group">
                            <label for="alterar-dia-semana">Selecione o novo dia da sessão:*</label>
                            <select id="alterar-dia-semana" class="form-control" required>
                                <option value="">Selecione...</option>
                                <option value="Segunda-feira">Segunda-feira</option>
                                <option value="Terça-feira">Terça-feira</option>
                                <option value="Quarta-feira">Quarta-feira</option>
                                <option value="Quinta-feira">Quinta-feira</option>
                                <option value="Sexta-feira">Sexta-feira</option>
                                <option value="Sábado">Sábado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="alterar-horario">Selecione o novo horário da sessão:*</label>
                            <select id="alterar-horario" class="form-control" required>
                                 </select>
                        </div>
                         <div class="form-group">
                            <label for="alterar-tipo-atendimento">Selecione o novo tipo de atendimento:*</label>
                            <select id="alterar-tipo-atendimento" class="form-control" required>
                                <option value="">Selecione...</option>
                                <option value="Online">Online</option>
                                <option value="Presencial">Presencial</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid cols-2"> <div class="form-group">
                            <label for="alterar-frequencia">O atendimento será realizado:*</label>
                            <select id="alterar-frequencia" class="form-control" required>
                                <option value="">Selecione...</option>
                                <option value="Semanal">Semanal</option>
                                <option value="Quinzenal">Quinzenal</option>
                                <option value="Mensal">Mensal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="alterar-data-inicio">Informe a partir de qual data:*</label>
                            <input type="date" id="alterar-data-inicio" class="form-control" required>
                        </div>
                    </div>
                     <div class="form-grid cols-2"> <div class="form-group">
                            <label for="alterar-sala">Selecione abaixo a sala:*</label>
                            <select id="alterar-sala" class="form-control" required>
                                <option value="Online">Online</option>
                                 </select>
                        </div>
                        <div class="form-group">
                            <label for="alterar-grade">Alterar/Incluir na grade?</label>
                            <select id="alterar-grade" class="form-control" required>
                                <option value="">Selecione...</option>
                                <option value="Sim">Sim</option>
                                <option value="Não">Não</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label for="alterar-justificativa">Justificativa (Opcional):</label>
                    <textarea id="alterar-justificativa" rows="3" class="form-control" placeholder="Descreva brevemente o motivo da alteração, se necessário."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
            <button type="button" class="action-button" id="btn-confirmar-alteracao-horario">Enviar Solicitação de Alteração</button>
        </div>
    </div>
</div>

<div id="reavaliacao-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 class="modal-title-text">Solicitar Reavaliação</h2>
             <span class="close-button modal-cancel-btn">&times;</span> </div>
        <div class="modal-body">

            <fieldset class="info-fieldset"> <legend>Passo a passo para agendar a Reavaliação</legend>
                <div class="reavaliacao-info-text">
                    <ol>
                        <li>
                            <strong>Critérios para reavaliação:</strong>
                            <ul>
                                <li>Estar há mais de 6 meses sendo atendido e não ter feito a reavaliação nesse período;</li>
                                <li>O Serviço Social deixou informado na ficha de triagem que deveria realizar uma reavaliação antes de 6 meses;</li>
                                <li>Identificou-se que o paciente tem condições de pagar um valor maior na contribuição;</li>
                                <li>Identificou-se que o paciente precisa reduzir o valor da contribuição.</li>
                            </ul>
                        </li>
                        <li><strong>Conversar com o paciente</strong> e orientar que uma das normas da EuPsico é a reavaliação, e que ele precisa passar novamente com o Serviço Social. Essa é uma das condições para ele continuar sendo atendido na EuPsico.</li>
                        <li><strong>Acessar a agenda de reavaliação</strong> junto com o paciente para agendar o melhor dia e horário.</li>
                        <li><strong>Preencher o formulário</strong> para notificar o administrativo (botão abaixo).</li>
                        <li>
                            <strong>Informar ao paciente</strong> que ele precisa encaminhar os seguintes documentos pelo WhatsApp da EuPsico:
                             <ul>
                                <li>Comprovante de endereço (dos últimos 3 meses);</li>
                                <li>Comprovante de renda (dos últimos 3 meses);</li>
                                <li>Caso não tenha carteira assinada ou renda, será necessário redigir uma carta de próprio punho com a declaração da renda familiar.</li>
                             </ul>
                        </li>
                        <li><strong>O administrativo entrará em contato para confirmar.</strong> (Para que isso aconteça, é fundamental preencher o formulário de notificação).</li>
                    </ol>
                </div>
            </fieldset>

            <div id="reavaliacao-form-container">

                <div id="reavaliacao-sem-agenda" class="alert alert-warning" style="display: none; text-align: center;"> Nenhuma agenda de reavaliação está configurada no momento. Por favor, entre em contato com o administrativo.
                </div>

                <form id="reavaliacao-form" style="display: none;">
                    <input type="hidden" id="reavaliacao-paciente-id">
                    <input type="hidden" id="reavaliacao-atendimento-id"> <fieldset>
                        <legend>Dados da Solicitação</legend>
                        <div class="form-grid cols-2"> <div class="form-group">
                                <label>Nome do Profissional</label>
                                <input type="text" id="reavaliacao-profissional-nome" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>Nome do Paciente</label>
                                <input type="text" id="reavaliacao-paciente-nome" class="form-control" readonly>
                            </div>
                         </div>
                         <div class="form-grid cols-2"> <div class="form-group">
                                <label for="reavaliacao-valor-atual">Valor da Contribuição Atual (R$)</label>
                                <input type="text" id="reavaliacao-valor-atual" class="form-control" placeholder="Ex: 50,00">
                            </div>
                            <div class="form-group">
                                <label for="reavaliacao-motivo">Qual o motivo da reavaliação?</label>
                                <textarea id="reavaliacao-motivo" class="form-control" rows="3" required placeholder="Descreva o motivo..."></textarea>
                            </div>
                         </div>
                    </fieldset>

                    <fieldset>
                        <legend>Agendamento da Reavaliação</legend>

                        <div id="reavaliacao-tipo-atendimento-group" class="form-group" style="display: none;">
                            <label for="reavaliacao-tipo-atendimento">Tipo de Atendimento</label>
                            <select id="reavaliacao-tipo-atendimento" class="form-control"></select>
                        </div>

                        <div id="reavaliacao-agenda-container">
                             <div class="form-group">
                                <label>Escolha a data:</label>
                                <div id="reavaliacao-datas-disponiveis" class="slots-container date-slots"> <p>Selecione uma modalidade para ver as datas.</p>
                                </div>
                                <input type="hidden" id="reavaliacao-data-selecionada">
                            </div>
                            <div class="form-group">
                                <label>Horários disponíveis:</label>
                                <div id="reavaliacao-horarios-disponiveis" class="slots-container"> <p>Selecione uma data para ver os horários.</p>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="action-button secondary-button modal-cancel-btn">Cancelar</button>
            <button type="button" class="action-button" id="btn-confirmar-reavaliacao" style="display: none;">Enviar Solicitação</button>
        </div>
    </div>
</div>